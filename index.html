<html>
    <head>
        <script src="/mieruca-tag.js"></script>
        <script>

            const mierucaProcess = {
                iID: null,
                canReopen: false,
	        urlWithoutSearch: `${location.protocol}://${location.host}${location.pathname}`,
                init: (step)=>{
                    mierucaProcess.iID = setInterval(()=>{
                        try {
                            if (window.__mierucaFcCustom !== undefined) {
			        const search = (() => {
				  const _ = [];
			          _.push(`preview=${step}`);
				  return _.join(`&`);
				})();
			        window.__mierucaFcCustom.open(`${mierucaProcess.urlWithoutSearch}?${search}`);
                                clearInterval(mierucaProcess.iID);
                                mierucaProcess.iID = null;
                                mierucaProcess.canReopen = true;
                            }
                        } catch (e) {
                            clearInterval(mierucaProcess.iID);
                            mierucaProcess.iID = null;
                            console.warn(e);
                        }
                    }
                    , 100);
                }
                ,
                move: (step)=>{
                    try {
                        const maxRetry = 5;
                        let retryCount = 0;
                        let id = setInterval(()=>{
                            retryCount++;
                            if (window.__mierucaFcCustom !== undefined && mierucaProcess.canReopen === true) {
			        const search = (() => {
				  const _ = [];
			          _.push(`preview=${step}`);
				  return _.join(`&`);
				})();
				window.__mierucaFcCustom.reopen(`${mierucaProcess.urlWithoutSearch}?${search}`);
                                clearInterval(id);
                                id = null;
                            }
                            if (retryCount >= maxRetry) {
                                clearInterval(id);
                                id = null;
                            }
                        }
                        , 100);
                    } catch (e) {
                        console.warn(e);
                    }
                }
                ,
            }
            mierucaProcess.init(`1`);
            mierucaProcess.move(`2`);

        </script>
    </head>
    <body>
        hello
		<br>
        <input type="button" value="button1">
        <br>
        <input type="button" value="button2">
        <br>
        <input type="button" value="button3">
        <br>
        <input type="button" value="button4">
        <div style="height:3000px"></div>
    </body>
</html>
